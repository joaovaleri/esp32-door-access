<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Porta Principal • Login + Pulso ESP32</title>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    :root{
      --bg:#0f1115; --panel:#161a22; --hair:#222636; --text:#e6e8ee; --muted:#8b93a7;
      --primary:#5b8cff; --ok:#2ecc71; --danger:#ff6b6b; --warn:#f4c430;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; min-height:100svh; color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
      background:linear-gradient(180deg,#0d1016 0%, #0f1115 100%);
    }

    /* Gate de Login */
    #loginGate{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center; padding:20px;
    }
    .login-card{
      width:min(420px,92vw); background:rgba(22,26,34,.9); border:1px solid var(--hair);
      border-radius:16px; padding:22px 18px; text-align:center; backdrop-filter:blur(6px);
      box-shadow:0 12px 40px rgba(0,0,0,.35);
    }
    .login-card h1{margin:0 0 4px; font-size:22px}
    .muted{color:var(--muted); font-size:13px}
    .login-card input{
      width:100%; margin-top:10px; padding:10px 12px; border-radius:10px; background:#0f1320;
      border:1px solid #22283a; color:var(--text); font-size:14px;
    }
    .btn{ border:1px solid var(--hair); background:transparent; color:var(--text);
      padding:10px 12px; border-radius:10px; font-size:14px; cursor:pointer; }
    .btn:hover{ border-color:#2b3042 }
    .btn.primary{ background:var(--primary); border-color:var(--primary); color:#fff }
    .btn.ok{ background:var(--ok); border-color:var(--ok); color:#fff }
    .btn.danger{ background:var(--danger); border-color:var(--danger); color:#fff }

    #spinner{ display:none; margin:12px auto 0; border:2px solid #ddd; border-top:2px solid #fff; border-radius:50%; width:18px; height:18px; animation:spin .8s linear infinite }
    @keyframes spin { to{ transform:rotate(360deg) } }

    /* App */
    body.logged-out #app{ display:none }
    body.logged-in  #loginGate{ display:none }

    .wrap{
      max-width:1100px; margin:28px auto; padding:0 16px;
    }
    .panel{
      background:rgba(22,26,34,.9); border:1px solid var(--hair); border-radius:16px; padding:16px; backdrop-filter:blur(6px);
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    header.app-top{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px }
    h1{ margin:0; font-size:22px }

    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:16px }
    @media (max-width: 900px){ .grid{ grid-template-columns:1fr } }

    .hr{ height:1px; background:linear-gradient(90deg,#1b2132,#2a3248); margin:10px 0 }

    /* LEDs */
    .led-row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .leds{ display:flex; gap:8px }
    .led{ width:16px; height:16px; border-radius:50%; border:1px solid #2a3042; background:#111522 }
    .led.on{ background:var(--ok); box-shadow:0 0 10px rgba(46,204,113,.6) }
    .led-label{ font-size:12px; color:var(--muted) }

    /* Botões 1..10 */
    .pulse-grid{ display:grid; grid-template-columns:repeat(5,1fr); gap:8px }
    @media (max-width:520px){ .pulse-grid{ grid-template-columns:repeat(5,1fr) } }

    /* Agenda */
    .row{ display:flex; align-items:center; gap:8px; flex-wrap:wrap }
    select, input[type="time"], input[type="number"], input[type="text"]{
      background:#0f1320; border:1px solid #22283a; color:var(--text); padding:8px 10px; border-radius:10px; font-size:13px;
    }
    ul.clean{ list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:8px }
    .card{ background:#121620; border:1px solid #1e2230; border-radius:14px; padding:12px; display:flex; align-items:center; justify-content:space-between; gap:12px }
    .badge{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:11px; border:1px solid var(--hair); background:#0f1320; color:var(--muted) }
    .badge.warn{ background:#2a1d10; color:#f4c430; border-color:#3b2b14 }

    /* Overlay busy */
    #loadingOverlay{ position:fixed; inset:0; z-index:2000; display:none; align-items:center; justify-content:center; flex-direction:column; gap:12px; background:rgba(0,0,0,.45); backdrop-filter:blur(2px); color:#e6e8ee; font-weight:600 }
    #loadingOverlay .loader{ width:48px; height:48px; border-radius:50%; border:4px solid rgba(255,255,255,.25); border-top-color:#fff; animation:spin 1s linear infinite }

    /* Modal feriados */
    #feriadosModal{ position:fixed; inset:0; z-index:3000; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.45); backdrop-filter:blur(2px) }
    .modal-card{ width:min(640px,95vw); max-height:85vh; overflow:auto; background:#161a22; border:1px solid #2b3042; border-radius:16px; padding:16px; color:#e6e8ee }

    /* Pequenas utilidades */
    .space{ height:10px }
    .right{ margin-left:auto }
  </style>
</head>
<body class="logged-out">

  <!-- GATE DE LOGIN -->
  <section id="loginGate">
    <div class="login-card">
      <h1>Entrar</h1>
      <div class="muted">Use seu e-mail e senha (Firebase)</div>
      <input id="email" type="email" placeholder="E-mail" autocomplete="username" />
      <input id="senha" type="password" placeholder="Senha" autocomplete="current-password" />
      <div class="space"></div>
      <div class="row" style="justify-content:center">
        <button class="btn primary" id="btnLogin" type="button">Entrar</button>
        <a class="btn" id="btnVoltar" href="https://ime.unicamp.br/~operacional" aria-label="Voltar ao Operacional IMECC">Voltar</a>
      </div>
      <div id="spinner" aria-hidden="true"></div>
      <div id="loginStatus" class="muted" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- APP -->
  <main id="app">
    <div class="wrap">
      <header class="app-top">
        <h1>Porta Principal <span class="badge">ESP32</span></h1>
        <div class="row">
          <span id="useremail" class="muted" title="Usuário logado"></span>
          <button class="btn" id="btnLogout" type="button">Sair</button>
        </div>
      </header>

      <section class="grid">
        <!-- Painel principal -->
        <section class="panel">
          <h2 style="margin:0 0 6px">Estados rápidos</h2>
          <div class="muted" style="margin-bottom:10px">Envie pulsos 1–10 para o ESP32</div>

          <div id="pulsoStatus" class="muted" aria-live="polite" style="min-height:18px"></div>

          <div class="pulse-grid" aria-label="Botões de pulso">
            <button class="btn" data-pulse="1">1</button>
            <button class="btn" data-pulse="2">2</button>
            <button class="btn" data-pulse="3">3</button>
            <button class="btn" data-pulse="4">4</button>
            <button class="btn" data-pulse="5">5</button>
            <button class="btn" data-pulse="6">6</button>
            <button class="btn" data-pulse="7">7</button>
            <button class="btn" data-pulse="8">8</button>
            <button class="btn" data-pulse="9">9</button>
            <button class="btn" data-pulse="10">10</button>
          </div>

          <div class="hr"></div>

          <div class="led-row">
            <div class="led-label">LEDs:</div>
            <div id="leds" class="leds" aria-label="Indicadores do contador">
              <span class="led" data-i="0" title="LED 1"></span>
              <span class="led" data-i="1" title="LED 2"></span>
              <span class="led" data-i="2" title="LED 3"></span>
              <span class="led" data-i="3" title="LED 4"></span>
              <span class="led" data-i="4" title="LED 5"></span>
              <span class="led" data-i="5" title="LED 6"></span>
            </div>
            <span id="ledLinha" class="muted" style="font-family:monospace"></span>
          </div>

          <div class="space"></div>
          <div class="row">
            <div class="badge">Contador: <span id="contador_valor">--</span></div>
            <button id="btnResetEsp" class="btn danger right" type="button">Reset ESP32</button>
          </div>
        </section>

        <!-- Agenda e Feriados -->
        <section class="panel">
          <h2 style="margin:0 0 6px">Agenda (Horários Automáticos)</h2>
          <form id="agendaForm" class="row" autocomplete="off">
            <input type="time" id="agendaHorario" required>
            <input type="number" id="agendaEstadoNumero" min="1" max="11" required placeholder="Estado">
            <select id="agendaTipo" required>
              <option value="D">Dia de semana</option>
              <option value="F">Feriado/Fim de semana</option>
            </select>
            <button class="btn primary" type="submit">Adicionar</button>
            <button class="btn" type="button" id="btnFeriados">Gerenciar Feriados</button>
          </form>

          <div class="hr"></div>
          <ul id="listaAgenda" class="clean"></ul>
          <details style="margin-top:6px">
            <summary class="muted">Ver JSON da agenda</summary>
            <pre id="jsonAgenda" style="white-space:pre-wrap"></pre>
          </details>
        </section>
      </section>
    </div>
  </main>

  <!-- Overlay Busy -->
  <div id="loadingOverlay" role="status" aria-live="polite">
    <div class="loader" aria-hidden="true"></div>
    <p>Carregando…</p>
  </div>

  <!-- Modal Feriados -->
  <div id="feriadosModal">
    <div class="modal-card">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px;">
        <h3 style="margin:0">Feriados configurados</h3>
        <div class="row">
          <button class="btn" id="btnCloseFeriados" type="button">Fechar</button>
          <button class="btn ok" id="btnConfirmarFeriados" type="button">Confirmar & Reset</button>
        </div>
      </div>
      <div class="hr"></div>
      <form id="feriadoForm" class="row" style="margin-bottom:10px">
        <input id="feriadoDia" type="number" min="1" max="31" required placeholder="Dia" style="width:80px">
        <input id="feriadoMes" type="number" min="1" max="12" required placeholder="Mês" style="width:80px">
        <button class="btn primary" type="submit">Adicionar</button>
      </form>
      <ul id="listaFeriados" class="clean"></ul>
    </div>
  </div>

  <script>
    // ===== Helpers =====
    const qs = (s, el=document)=>el.querySelector(s);
    const qsa = (s, el=document)=>Array.from(el.querySelectorAll(s));
    function busy(on, msg){ const ov=qs('#loadingOverlay'); ov.style.display = on? 'flex':'none'; const p=qs('#loadingOverlay p'); if(p&&msg) p.textContent = msg; }

    // ===== Firebase Config =====
    const firebaseConfig = {
      apiKey: "AIzaSyBAiZhMqSHQ_zXlxIPMGyKzeWqERp9PaA4",
      authDomain: "modos-da-porta.firebaseapp.com",
      databaseURL: "https://modos-da-porta-default-rtdb.firebaseio.com",
      projectId: "modos-da-porta",
      storageBucket: "modos-da-porta.appspot.com",
      messagingSenderId: "630666478662",
      appId: "1:630666478662:web:9f19eccca9ab3ae6ebb647",
      measurementId: "G-M2NKEQEH34"
    };

    firebase.initializeApp(firebaseConfig);
    firebase.auth().setPersistence(firebase.auth.Auth.Persistence.NONE);

    // ===== Estado de Auth =====
    firebase.auth().onAuthStateChanged((user)=>{
      if(user){
        document.body.classList.add('logged-in');
        document.body.classList.remove('logged-out');
        qs('#useremail').textContent = user.email || '';
        atualizarContador();
        atualizarAgenda();
      }else{
        document.body.classList.remove('logged-in');
        document.body.classList.add('logged-out');
        qs('#useremail').textContent = '';
        qs('#email').value = '';
        qs('#senha').value = '';
        qs('#loginStatus').textContent = '';
      }
    });

    // ===== Login / Logout =====
    qs('#btnLogin').addEventListener('click', ()=>{
      const email = qs('#email').value.trim();
      const senha = qs('#senha').value;
      if(!email || !senha){ qs('#loginStatus').textContent = 'Preencha e-mail e senha'; return; }
      qs('#loginStatus').textContent = '';
      qs('#spinner').style.display = 'inline-block';
      firebase.auth().signInWithEmailAndPassword(email, senha)
        .then(()=>{ qs('#spinner').style.display = 'none'; })
        .catch(err=>{ qs('#spinner').style.display = 'none'; qs('#loginStatus').textContent = 'Erro: ' + err.message; });
    });

    qs('#btnLogout').addEventListener('click', ()=>{ location.reload(); });

    // ===== Pulso =====
    qsa('[data-pulse]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const valor = Number(btn.getAttribute('data-pulse'));
        const caminho = 'porta/pulso';
        const s = qs('#pulsoStatus'); s.textContent = `Enviando pulso ${valor}…`;
        firebase.database().ref(caminho).set(valor)
          .then(()=>{ s.textContent = `Pulso ${valor} enviado!`; setTimeout(()=>s.textContent='', 2000) })
          .catch(err=>{ s.textContent = 'Erro ao enviar: ' + err.message; });
      });
    });

    // ===== Reset ESP =====
    qs('#btnResetEsp').addEventListener('click', ()=>{
      if(!confirm('Tem certeza que deseja resetar o ESP32?')) return;
      firebase.database().ref('porta/reset').set(1).then(()=>{
        alert('Comando de reset enviado para o ESP32!');
      });
    });

    // ===== LEDs + Contador =====
    const LEDS_TOTAL = 6;
    function renderizarLEDTexto(valor){
      const arr = Array(LEDS_TOTAL).fill(0);
      if(valor >= 1 && valor <= 5){ arr[valor-1] = 1; }
      else if(valor >= 6 && valor <= 10){ arr[5] = 1; arr[valor-6] = 1; }
      // Atualiza bolinhas
      qsa('#leds .led').forEach((el,i)=>{ el.classList.toggle('on', !!arr[i]); });
      // String 0//0...
      qs('#ledLinha').textContent = arr.join('//');
    }

    function atualizarContador(){
      firebase.database().ref('porta/contador').on('value', (snap)=>{
        const v = snap.val();
        qs('#contador_valor').textContent = (v!==null && v!==undefined) ? v : '--';
        renderizarLEDTexto(Number(v||1));
      });
    }
    renderizarLEDTexto(1);

    // ===== Agenda =====
    qs('#agendaForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const hora = qs('#agendaHorario').value;
      const estadoNumero = parseInt(qs('#agendaEstadoNumero').value, 10);
      const tipo = qs('#agendaTipo').value; // D ou F
      if(!hora || isNaN(estadoNumero) || !tipo) return;
      const estado = `${estadoNumero}${tipo}`; // ex: 3F
      firebase.database().ref('agenda/agenda/' + hora).set(estado).then(()=>{
        qs('#agendaForm').reset();
      });
    });

    function removerHorarioAgenda(hora){
      firebase.database().ref('agenda/agenda/' + hora).remove();
    }

    function atualizarAgenda(){
      firebase.database().ref('agenda/agenda').on('value', (snapshot)=>{
        const lista = qs('#listaAgenda'); lista.innerHTML = '';
        const agenda = snapshot.val() || {};
        Object.keys(agenda).sort().forEach(hora=>{
          const estado = agenda[hora];
          const num = String(estado).replace(/\D+/g,'');
          const tipo = String(estado).toUpperCase().endsWith('F') ? 'Feriado/Fim de semana' : 'Dia de semana';
          const li = document.createElement('li');
          li.className = 'card';
          li.innerHTML = `
            <div>
              <strong>${hora}</strong>
              <div class="muted">estado <b>${num}</b> • <em>${tipo}</em></div>
            </div>
            <div class="row">
              <button class="btn" aria-label="Remover horário ${hora}" onclick="removerHorarioAgenda('${hora}')">Remover</button>
            </div>`;
          lista.appendChild(li);
        });
        qs('#jsonAgenda').textContent = JSON.stringify(agenda, null, 2);
      });
    }

    // ===== Feriados (Modal) =====
    function abrirFeriados(){ qs('#feriadosModal').style.display = 'flex'; atualizarListaFeriados(); }
    function fecharFeriados(){ qs('#feriadosModal').style.display = 'none'; }
    qs('#btnFeriados').addEventListener('click', ()=>{
      if(!confirm('Deseja realmente gerenciar os feriados? Fazer isso pode exigir reset do ESP32.')) return;
      abrirFeriados();
    });
    qs('#btnCloseFeriados').addEventListener('click', fecharFeriados);

    qs('#feriadoForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      let dia = parseInt(qs('#feriadoDia').value, 10);
      let mes = parseInt(qs('#feriadoMes').value, 10);
      if(isNaN(dia)||isNaN(mes)||dia<1||dia>31||mes<1||mes>12) return;
      dia = String(dia).padStart(2,'0');
      mes = String(mes).padStart(2,'0');
      const chave = `${dia}-${mes}`;
      firebase.database().ref('agenda/feriados/' + chave).set(true).then(()=>{
        qs('#feriadoForm').reset();
      });
    });

    function removerFeriado(chave){ firebase.database().ref('agenda/feriados/' + chave).remove(); }

    function atualizarListaFeriados(){
      firebase.database().ref('agenda/feriados').on('value', (snapshot)=>{
        const lista = qs('#listaFeriados'); lista.innerHTML = '';
        const feriados = snapshot.val() || {};
        Object.keys(feriados)
          .sort((a,b)=>{ const [da,ma]=a.split('-').map(Number); const [db,mb]=b.split('-').map(Number); return ma!==mb ? ma-mb : da-db; })
          .forEach(chave=>{
            const li = document.createElement('li');
            li.className = 'card';
            li.innerHTML = `
              <div><b>${chave}</b></div>
              <div class="row">
                <button class="btn" aria-label="Remover feriado ${chave}" onclick="removerFeriado('${chave}')">Remover</button>
              </div>`;
            lista.appendChild(li);
          });
      });
    }

    qs('#btnConfirmarFeriados').addEventListener('click', ()=>{
      firebase.database().ref('porta/reset').set(1).then(()=>{
        alert('Configurações de feriados salvas e comando de reset enviado ao ESP32!');
        fecharFeriados();
      });
    });

    // Fecha modal clicando fora ou com ESC
    document.addEventListener('click', (e)=>{ if(e.target && e.target.id==='feriadosModal') fecharFeriados(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && qs('#feriadosModal').style.display!=='none') fecharFeriados(); });
  </script>
</body>
</html>
